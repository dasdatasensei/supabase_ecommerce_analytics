#!/bin/bash
set -e

echo "Creating ***REMOVED*** user and setting up database..."

# Run SQL commands to create user and database
docker exec -i ecommerceanalytics-supabase-db-1 psql -U postgres << EOF
-- Create the user if it doesn't exist
CREATE USER ***REMOVED*** WITH PASSWORD '***REMOVED***';
ALTER USER ***REMOVED*** WITH SUPERUSER;

-- Create the database if it doesn't exist
SELECT 'CREATE DATABASE "ecommerce-db"' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'ecommerce-db') \gexec
GRANT ALL PRIVILEGES ON DATABASE "ecommerce-db" TO ***REMOVED***;

-- Connect to the ecommerce-db database
\c "ecommerce-db"

-- Create schema
CREATE SCHEMA IF NOT EXISTS olist;
GRANT ALL ON SCHEMA olist TO ***REMOVED***;
GRANT ALL PRIVILEGES ON SCHEMA olist TO ***REMOVED***;

-- Create extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- Create Supabase required schemas
CREATE SCHEMA IF NOT EXISTS auth;
CREATE SCHEMA IF NOT EXISTS storage;
CREATE SCHEMA IF NOT EXISTS graphql;
CREATE SCHEMA IF NOT EXISTS realtime;
GRANT ALL ON SCHEMA auth TO ***REMOVED***;
GRANT ALL ON SCHEMA storage TO ***REMOVED***;
GRANT ALL ON SCHEMA graphql TO ***REMOVED***;
GRANT ALL ON SCHEMA realtime TO ***REMOVED***;

-- Check the role exists
SELECT rolname FROM pg_roles WHERE rolname='***REMOVED***';
EOF

echo "Database setup completed successfully!"